<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Shawn çš„ç¿»è¯‘ä¸»é¡µ</title>
  <style>
    :root { --w: 92vw; max-width: 900px; }
    body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,Helvetica,sans-serif; 
           margin: 24px; display: flex; justify-content: center; }
    .wrap { width: min(var(--w), 900px); }
    h2 { text-align: center; margin: 0 0 12px; }
    .bar { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; align-items:center; }
    select,button,input[type=file]{ padding:10px 14px; font-size:16px; }
    textarea { width: 100%; height: 140px; margin: 12px 0; padding: 12px; font-size: 16px; line-height: 1.4; }
    #result { margin-top: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
              font-size: 18px; color: #0a3a8d; background:#f7f9ff; min-height: 48px; }
    .hint { color:#666; font-size:13px; text-align:center; margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ğŸŒ Shawn çš„ç¿»è¯‘ä¸»é¡µ</h2>

    <div class="bar">
      <label for="langSelect">é€‰æ‹©ç¿»è¯‘æ–¹å‘ï¼š</label>
      <select id="langSelect" aria-label="ç¿»è¯‘æ–¹å‘">
        <option value="zh|en">ä¸­æ–‡ â†’ è‹±æ–‡</option>
        <option value="en|zh">è‹±æ–‡ â†’ ä¸­æ–‡</option>
      </select>
      <button onclick="translateText()">ç¿»è¯‘æ–‡å­—</button>
      <button onclick="startSpeech()">ğŸ¤ è¯­éŸ³è¾“å…¥</button>
      <input type="file" accept="image/*" onchange="handleImage(this)" title="æ‹ç…§/ä¸Šä¼ å›¾ç‰‡è¿›è¡Œæ–‡å­—è¯†åˆ«"/>
    </div>

    <textarea id="inputText" placeholder="åœ¨è¿™é‡Œè¾“å…¥è¦ç¿»è¯‘çš„æ–‡å­—ï¼Œæˆ–ä½¿ç”¨è¯­éŸ³/æ‹ç…§è¯†åˆ«â€¦"></textarea>

    <div id="result" role="status" aria-live="polite">ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
    <div class="hint">æç¤ºï¼šè¯­éŸ³è¾“å…¥ä¾èµ–æµè§ˆå™¨çš„ Web Speech APIï¼›æ‹ç…§ç¿»è¯‘ä½¿ç”¨ OCR.Space çš„å…¬å¼€ç¤ºä¾‹æ¥å£ã€‚</div>
  </div>

  <script>
    // ç®€å•çš„é˜²æŠ–
    let translating = false;

    // æ–‡å­—ç¿»è¯‘ï¼ˆGoogle Translate éå®˜æ–¹ Web æ¥å£ï¼Œä»…ä½œæ¼”ç¤ºï¼‰
    async function translateText(text) {
      try {
        if (translating) return;
        translating = true;

        let q = document.getElementById('inputText').value.trim();
        if (text) q = text.trim();
        if (!q) { show('è¯·è¾“å…¥å†…å®¹'); translating = false; return; }

        // è¯»å–è¯­è¨€æ–¹å‘
        const [from, to] = document.getElementById('langSelect').value.split('|');

        // å‘èµ·è¯·æ±‚
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${from}&tl=${to}&dt=t&q=${encodeURIComponent(q)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('ç½‘ç»œé”™è¯¯ï¼š' + res.status);
        const data = await res.json();

        // ç»„è£…å¤šæ®µç»“æœ
        const parts = data[0].map(seg => seg[0]).join('');
        show(parts || 'ï¼ˆæ— ç»“æœï¼‰');
      } catch (e) {
        show('ç¿»è¯‘å¤±è´¥ï¼š' + e.message);
      } finally {
        translating = false;
      }
    }

    function show(msg){ document.getElementById('result').innerText = msg; }

    // è¯­éŸ³è¾“å…¥
    function startSpeech() {
      const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Speech) { alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«'); return; }

      // æ ¹æ®æ–¹å‘è‡ªåŠ¨è®¾ç½®è¯†åˆ«è¯­è¨€
      const [from] = document.getElementById('langSelect').value.split('|');
      const langMap = { zh: 'zh-CN', en: 'en-US' };

      const r = new Speech();
      r.lang = langMap[from] || 'zh-CN';
      r.interimResults = false;
      r.maxAlternatives = 1;
      r.start();
      r.onresult = e => {
        const text = e.results[0][0].transcript;
        document.getElementById('inputText').value = text;
        translateText(text);
      };
      r.onerror = e => alert('è¯­éŸ³è¯†åˆ«å‡ºé”™ï¼š' + (e.error || 'unknown'));
    }

    // å›¾ç‰‡ OCR + ç¿»è¯‘ï¼ˆOCR.Space Demo Keyï¼Œä»…ä½œæ¼”ç¤ºï¼‰
    async function handleImage(input) {
      const file = input.files && input.files[0];
      if (!file) return;

      try {
        show('æ­£åœ¨è¯†åˆ«å›¾ç‰‡æ–‡å­—â€¦');
        const fd = new FormData();
        fd.append('apikey', 'helloworld'); // Demo keyï¼šé€Ÿç‡å’Œé…é¢æœ‰é™
        fd.append('file', file);
        // è¯­è¨€é€‰æ‹©æ ¹æ®å½“å‰ from è¯­è¨€æ¥è®¾ç½®æ›´åˆç†çš„ OCR è¯­è¨€
        const [from] = document.getElementById('langSelect').value.split('|');
        const ocrLang = (from === 'en') ? 'eng' : 'chs';
        fd.append('language', ocrLang);

        const res = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: fd });
        const data = await res.json();
        if (!data.ParsedResults || !data.ParsedResults[0]) throw new Error('æœªè¯†åˆ«åˆ°æ–‡å­—');
        const text = data.ParsedResults[0].ParsedText || '';
        document.getElementById('inputText').value = text.trim();
        translateText(text);
      } catch (e) {
        show('è¯†åˆ«å¤±è´¥ï¼š' + e.message);
      } finally {
        // æ¸…ç©º input ä»¥ä¾¿ä¸‹æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶ä¹Ÿä¼šè§¦å‘ change
        input.value = '';
      }
    }
  </script>
</body>
</html>